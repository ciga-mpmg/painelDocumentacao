[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Documentação do Painel CIGA-MPMG",
    "section": "",
    "text": "Introdução\nEste documento apresenta a documentação do Painel desenvolvido para o CIGA-MPMG.\nDevido à complexidade do painel, o projeto está estruturado em diferentes partes, cada um com um propósito específico.\nOs softwares foram desenvolvidos e versionados utilizando o sistema de controle de versão Git e estão disponíveis em repositórios privados no GitHub.",
    "crumbs": [
      "Introdução"
    ]
  },
  {
    "objectID": "paineis.html",
    "href": "paineis.html",
    "title": "1  Painéis do CIGA-MPMG",
    "section": "",
    "text": "1.1 Estrutura básica\nTodos os paineis com exeção de painelMain dependem de uma série de configurações e dependências de ambiente. São elas:\nTodos os apps contam com uma infraestrutura de login que depende das variáveis de ambiente. Essa infraestrutura é:\nAs configurações para obter o endpoint de validação do login estão registradas em https://github.com/ciga-mpmg/painelAssets/blob/main/inst/app/golem-config.yml. A mecânica e front-end de validação estão no repositório painelLogin.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Painéis do CIGA-MPMG</span>"
    ]
  },
  {
    "objectID": "paineis.html#estrutura-básica",
    "href": "paineis.html#estrutura-básica",
    "title": "1  Painéis do CIGA-MPMG",
    "section": "",
    "text": "Ubuntu 20.04\nR 4.2.1 ou superior\nShiny-Server em versão 1.5.19 ou superior\nVariáveis de ambiente:\n\nCIGA_SQL_HOST  # endereço de acesso ao banco de dados\nCIGA_SQL_DATABASE # banco de dados\nCIGA_SQL_USER # usuário do banco\nCIGA_SQL_PORT # porta do banco\nCIGA_SQL_PASSWORD # senha\nAMBIENTE # stringr que deve ser \"homolog\" ou \"prod\"\nCIGA_OUTLOOK_TENANT # tenant do outlook\nCIGA_OUTLOOK_APP # id do aplicativo do outlook\nCIGA_OUTLOOK_PASSWORD # senha do outlook\nCIGA_FIREBASE_PASSWORD # senha de acesso ao firebase no usuario contato@ciga-mpmg.com.br\nCIGA_FIREBASE_PROJECT_API=\"AIzaSyCH-0lM6fq2Wgx7NfGedRDJnV9Bxa4ifoo\" # projeto do firebase\n\nif (ambiente %in% c(\"homolog\", \"prod\")) {\n    url &lt;- get_golem_config(\"url\", Sys.getenv(\"AMBIENTE\"))\n    validation_endpoint &lt;- get_golem_config(\n      \"validation_endpoint\",\n      Sys.getenv(\"AMBIENTE\")\n    )\n    active_ui &lt;- painelLogin:::create_app_ui_auth(\n      request,\n      app_ui,\n      url,\n      validation_endpoint\n    )\n  } else {\n    active_ui &lt;- app_ui\n    url &lt;- NULL\n  }",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Painéis do CIGA-MPMG</span>"
    ]
  },
  {
    "objectID": "paineis.html#mecanismo-de-autenticação",
    "href": "paineis.html#mecanismo-de-autenticação",
    "title": "1  Painéis do CIGA-MPMG",
    "section": "1.2 Mecanismo de autenticação",
    "text": "1.2 Mecanismo de autenticação\nO mecanismo de autenticação de todo acesso se divide em dois casos: se há token de acesso nos cookies do usuário ou não. Se não houver, o fluxo de acesso é:\n\nInterromper o acesso ao app e expor a UI de login do painelLogin.\nA função validate_session usa o ToolKit do firebase para verificar se as credenciais são válidas.\nSe forem válidas, um token é devolvido paro usuário e salvo nos cookies.\nQuando as credenciais são válidas também é fornecido acesso ao painel.\n\n\nknitr::include_graphics(\"img/fluxoFirebase.png\")",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Painéis do CIGA-MPMG</span>"
    ]
  },
  {
    "objectID": "paineis.html#direcionamento-via-nginx",
    "href": "paineis.html#direcionamento-via-nginx",
    "title": "1  Painéis do CIGA-MPMG",
    "section": "1.3 Direcionamento via nginx",
    "text": "1.3 Direcionamento via nginx\nA compatibilização de todos os apps como uma única aplicação é feita com direcionamento via nginx. As configurações de location do nginx são:\n    location / {\n                # block added from rstudio support doc\n                proxy_pass http://localhost:3838;\n                proxy_redirect / $scheme://$http_host/;\n                proxy_http_version 1.1;\n                proxy_set_header Upgrade $http_upgrade;\n                proxy_set_header Connection $connection_upgrade;\n                proxy_read_timeout 20d;\n                proxy_buffering off;\n    }\nJá as configurações de redirecionamento são\nserver {\n\n        listen 80;\n        server_name painel-homolog.ciga-mpmg.com.br;\n        rewrite     ^   https://$server_name$request_uri? redirect;\n\n        # Tamamho maximo de upload\n        #client_max_body_size 125m;\n\n        #proxy_headers_hash_max_size 2048;\n        #proxy_headers_hash_bucket_size 128;\n\n\n    location ^~ /.well-known/acme-challenge/ {\n         alias /var/www/html/.well-known/acme-challenge/;\n    }\n\n    location / {\n      proxy_pass http://127.0.0.1:3838/painelMain$request_uri;\n      proxy_redirect / $scheme://$http_host$request_uri;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection $connection_upgrade;\n      proxy_read_timeout 20d;\n      proxy_buffering off;\n\n\n       # Websockets support\n  #      proxy_set_header Upgrade \"websocket\";\n  #      proxy_set_header Connection \"Upgrade\";\n\n    }\n\n    location /recomendacoes {\n      proxy_pass http://127.0.0.1:3838/painelRecomendacoes/;\n      proxy_redirect / $scheme://$http_host$request_uri;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection $connection_upgrade;\n      proxy_read_timeout 20d;\n      proxy_buffering off;\n\n    }\n}\n\nserver {\n    listen 443 ssl;\n    server_name painel-homolog.ciga-mpmg.com.br;\n\n    ssl on;\n    ssl_certificate       /etc/letsencrypt/live/painel-homolog.ciga-mpmg.com.br/fullchain.pem;\n    ssl_certificate_key   /etc/letsencrypt/live/painel-homolog.ciga-mpmg.com.br/privkey.pem;\n\n    proxy_headers_hash_max_size 2048;\n    proxy_headers_hash_bucket_size 128;\n\n    location ^~ /.well-known/acme-challenge/ {\n         alias /var/www/html/.well-known/acme-challenge/;\n    }\n\n    location / {\n      proxy_pass http://127.0.0.1:3838/painelMain$request_uri;\n      proxy_redirect / $scheme://$http_host$request_uri;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection $connection_upgrade;\n      proxy_read_timeout 20d;\n      proxy_buffering off;\n\n    error_page 404 500 502 /usr/share/nginx/html/custom_404.html;\n\n    }\n\n    location /recomendacoes/ {\n      proxy_pass http://127.0.0.1:3838/painelRecomendacoes/;\n      proxy_redirect / $scheme://$http_host$request_uri;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection $connection_upgrade;\n      proxy_read_timeout 20d;\n      proxy_buffering off;\n\n    }\n\n    location /tacs/ {\n      proxy_pass http://127.0.0.1:3838/painelInfoTacs/;\n      proxy_redirect / $scheme://$http_host$request_uri;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection $connection_upgrade;\n      proxy_read_timeout 20d;\n      proxy_buffering off;\n\n\n    }\n\n        location /barragens/ {\n      proxy_pass http://127.0.0.1:3838/painelBarragens/;\n      proxy_redirect / $scheme://$http_host$request_uri;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection $connection_upgrade;\n      proxy_read_timeout 20d;\n      proxy_buffering off;\n\n\n    }\n\n        location /descaracterizacao/ {\n      proxy_pass http://127.0.0.1:3838/painelDescaracterizacao/;\n      proxy_redirect / $scheme://$http_host$request_uri;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection $connection_upgrade;\n      proxy_read_timeout 20d;\n      proxy_buffering off;\n\n      error_page 404 500 502 /usr/share/nginx/html/custom_404.html;\n\n    }\n}",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Painéis do CIGA-MPMG</span>"
    ]
  },
  {
    "objectID": "bancos-de-dados.html",
    "href": "bancos-de-dados.html",
    "title": "2  Bancos de dados",
    "section": "",
    "text": "2.1 Banco de dados principal\nO banco de dados aecom_ciga_homolog contém diversas bases de dados de temas como: recomendações, sigbm, tabelas que deverão ser deletadas após parar de usar o Shinyapps, entre outros.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Bancos de dados</span>"
    ]
  },
  {
    "objectID": "bancos-de-dados.html#banco-de-dados-principal",
    "href": "bancos-de-dados.html#banco-de-dados-principal",
    "title": "2  Bancos de dados",
    "section": "",
    "text": "Importante\n\n\n\nEsse banco de dados tem “AECOM” no nome. O Rubem disse que isso não é desejável. Checar com a equipe da AECOM o que fazer sobre isso.\n\n\n\n2.1.1 Painéis que utilizam o banco de dados\nEsse banco de dados é utilizado nos seguintes painéis:\n\npainelRecomendacoes\npainelBarragens\n\n\n\n2.1.2 Tabelas no banco de dados\nSegue abaixo a lista de tabelas presentes no banco de dados aecom_ciga_homolog:\n\n\ncomarcasTJMG\ndados_recomendacoes_sigbm\ndados_recomendacoes_sigbm_complexo_minerario\ndados_sigbm_atualizacao_mensal\ndados_sigbm_linha_do_tempo\ndados_sigbm_linha_do_tempo_parcial\nentrepreneurs\nfull_recommendations\ngeography_columns\ngeometry_columns\ngeotechnical_structures\nide_sisema\nmetadados_documentos_tacs\nmetadados_imagens_satelite_bucket\nmetadados_imagens_satelite_bucket_local\nmetadados_mascaras_imagens_satelite_bucket\nmetadados_relatorios_gerenciais\npg_stat_statements\npg_stat_statements_info\nrecommendations3\nsigbm\nsigbm_atual\nsigbm_atual_com_comarcas\nsigbm_dados_cadastrais\nsigbm_dados_cadastrais_atual\nspatial_ref_sys\ntac_decharacterisations\ntacs\n\n\n\n\n2.1.3 Descrição das tabelas\nTabelas não utilizadas (são criadas pelo próprio sistema de banco de dados, e não são manipuladas/utilizadas no projeto):\ngeography_columns, geometry_columns, pg_stat_statements, pg_stat_statements_info, spatial_ref_sys.\nTabelas utilizadas:\n\ncomarcasTJMG:\n\nDescrição: Comarcas do TJMG.\nCriação: ETL feito pelo workflow download-comarcas-TJMG, no repositório ciga-mpmg/download_comarcas_TJMG. Depende do pacote comarcasTJMG.\nLeitura: scraper_sigbm.\n\nrecommendations3:\n\nDescrição: Tabela de recomendações emitidas para os TACs, por auditorias.\nCriação: Sistema de cadastro de TACs.\nLeitura: scraper_sigbm, relatorioGerencial.\n\nsigbm:\n\nDescrição: Tabela completa de informações extraídas da página principal do SIGBM, com informações sobre barragens no estado de Minas Gerais.\nCriação: ETL realizado no repositório scraper_sigbm.\nLeitura: scraper_sigbm, painelBarragens.\n\nsigbm_atual:\n\nDescrição: Tabela apenas com as informações mais recentes extraídas da página principal do SIGBM, com informações sobre barragens no estado de Minas Gerais.\nCriação: ETL realizado no repositório scraper_sigbm.\nLeitura: scraper_sigbm, painelBarragens.\n\nsigbm_atual_com_comarcas:\n\nDescrição: Tabela apenas com as informações mais recentes extraídas da página principal do SIGBM, com informações sobre barragens no estado de Minas Gerais, e suas respectivas comarcas.\nCriação: ETL realizado no repositório scraper_sigbm.\nLeitura: painelBarragens.\n\ndados_recomendacoes_sigbm:\n\nDescrição: União (join) feita a partir das tabelas recommendations3 e sigbm.\nCriação: repositório scraper_sigbm.\nLeitura: scraper_sigbm, painelRecomendacoes, relatorioGerencial.\n\ndados_recomendacoes_sigbm_complexo_minerario:\n\nDescrição: Resultado da união (join) da tabela com as recomendações, informações sobre o sigbm e informações sobre o complexo minerário.\nCriação: repositório scraper_sigbm.\nLeitura: painelRecomendacoes, googleStorageMetadata.\n\n\n\n\n\n\n\n\nImportante\n\n\n\n[JAN/2024] Me parece que antes esse fluxo era necessário pois as tabelas de complexo minerário estavam separadas. Agora, como vem com o banco, talvez seria bom reavaliar com calma se isso está fazendo sentido.\n\n\n\ndados_sigbm_atualizacao_mensal:\n\nDescrição: Tratamento da tabela sigbm para gerar a tabela de atualização mensal.\nCriação: repositório scraper_sigbm.\nLeitura: painelBarragens.\n\ndados_sigbm_linha_do_tempo e dados_sigbm_linha_do_tempo_parcial:\n\nDescrição: Tratamento da tabela sigbm para gerar linha do tempo.\nCriação: repositório scraper_sigbm.\nLeitura: painelBarragens.\n\nfull_recommendations:\n\nDescrição: ??\nCriação: ??\nLeitura: Nenhum\n\nide_sisema:\n\nDescrição: Dados do IDE SISEMA.\nCriação: download_IDE_SISEMA\nLeitura: Nenhum\n\nmetadados_documentos_tacs, metadados_imagens_satelite_bucket, metadados_imagens_satelite_bucket_local, metadados_mascaras_imagens_satelite_bucket, metadados_relatorios_gerenciais:\n\nDescrição: Metadados extraídos do Google Storage, com informações sobre os documentos dos TACs, imagens de satélite, relatórios gerenciais, etc.\nCriação: googleStorageMetadata.\nLeitura: painelBarragens, painelRecomendacoes.\n\nsigbm_dados_cadastrais e sigbm_dados_cadastrais_atual:\n\nDescrição: Dados extraídos da página completa do SIGBM, com informações sobre barragens no estado de Minas Gerais. Essa base de dados contém mais dados do que a base sigbm.\nCriação: ciga-monitoramento-info-barragens/sigbm-dados-cadastrais\nLeitura: Nenhum.\n\n\n\n\n\n\n\n\nTabelas que ainda são usadas no painel do Shinyapps, mas que agora usamos do banco de dadoscadastro-tacs e poderão ser deletadas futuramente do banco de dados aecom_ciga_homolog:\n\nentrepreneurs cópia antiga da tabela presente no banco de dados cadastro-tacs.\ngeotechnical_structures cópia antiga da tabela presente no banco de dados cadastro-tacs.\ntac_decharacterisations cópia antiga da tabela presente no banco de dados cadastro-tacs.\ntacs cópia antiga da tabela presente no banco de dados cadastro-tacs.\n\nATENÇÃO: Analisar se essas tabelas estão sendo utilizadas em algum lugar antes de deletá-las.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Bancos de dados</span>"
    ]
  },
  {
    "objectID": "bancos-de-dados.html#banco-de-dados-externo",
    "href": "bancos-de-dados.html#banco-de-dados-externo",
    "title": "2  Bancos de dados",
    "section": "2.2 Banco de dados externo",
    "text": "2.2 Banco de dados externo\nO banco de dados cadastro-tacs contém informações sobre os TACs (Termos de Ajustamento de Conduta) firmados pelo Ministério Público com empresas privadas.\nEsse banco de dados é utilizado nos seguintes repositórios:\n\nPainel Recomendações (ciga-mpmg/painelRecomendacoes)\n\n\n\n\n\n\n\nImportante\n\n\n\nO painelInfoTacs deveria usar os dados deste banco, certo? Conferir se está usando mesmo. Não apareceu na pesquisa do GitHub.\n\n\nTabelas utilizadas:\n\n\n\n\n\n\n\ntacs: Tacs de estruturas geotécnicas (não são de descaracterização).\n\nUtilizada em: Painel Recomendações.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Bancos de dados</span>"
    ]
  },
  {
    "objectID": "workflows.html",
    "href": "workflows.html",
    "title": "3  Workflows com GitHub Actions",
    "section": "",
    "text": "Para executar a obtenção e a preparação dos utilizados nos painéis e outros produtos relacionados ao CIGA, existem diversos workflows que são executados pelo GitHub Actions.\nWorkflows são arquivos de configuração que definem um conjunto de ações que são executadas em um ambiente de execução. Em alguns casos, o ambiente de execução são máquinas virtuais pertencentes à GitHub, em outros, o servidor do próprio CIGA.\nOs workflows existentes, e as informações sobre eles, estão descritas no arquivo https://github.com/ciga-mpmg/painelActions/blob/main/README.md.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Workflows com GitHub Actions</span>"
    ]
  }
]