[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Documentação do Painel CIGA-MPMG",
    "section": "",
    "text": "Introdução\nEste documento apresenta a documentação do Painel desenvolvido para o CIGA-MPMG.\nDevido à complexidade do painel, o projeto está estruturado em diferentes partes, cada um com um propósito específico.\nOs softwares foram desenvolvidos e versionados utilizando o sistema de controle de versão Git e estão disponíveis em repositórios privados no GitHub.",
    "crumbs": [
      "Introdução"
    ]
  },
  {
    "objectID": "bancos-de-dados.html",
    "href": "bancos-de-dados.html",
    "title": "2  Bancos de dados",
    "section": "",
    "text": "2.1 Banco de dados principal\nO banco de dados aecom_ciga_homolog contém diversas bases de dados de temas como: recomendações, sigbm, tabelas que deverão ser deletadas após parar de usar o Shinyapps, entre outros.\nEsse banco de dados é utilizado nos seguintes repositórios:\nTabelas não utilizadas (são criadas pelo próprio sistema de banco de dados, e não são manipuladas/utilizadas no projeto):\ngeography_columns, geometry_columns, pg_stat_statements, pg_stat_statements_info, spatial_ref_sys.\nTabelas utilizadas:",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Bancos de dados</span>"
    ]
  },
  {
    "objectID": "bancos-de-dados.html#banco-de-dados-cadastro-tacs",
    "href": "bancos-de-dados.html#banco-de-dados-cadastro-tacs",
    "title": "2  Bancos de dados",
    "section": "",
    "text": "Painel Recomendações (ciga-mpmg/painelRecomendacoes)\nPainel Descaracterização (ciga-mpmg/painelDescaracterizacao)\n\n\n\n\n\n\n\nImportante\n\n\n\nO painelInfoTacs deveria usar os dados deste banco, certo? Conferir se está usando mesmo. Não apareceu na pesquisa do GitHub.\n\n\n\n2.1.1 Tabelas do banco de dados “cadastro-tacs”\nTabelas não utilizadas (são criadas pelo próprio sistema de banco de dados, e não são manipuladas/utilizadas no projeto):\nactive_storage_attachments, active_storage_blobs, active_storage_variant_records, ar_internal_metadata, schema_migrations, users, pg_search_documents.\nTabelas vazias (conferir com a equipe da AECOM):\n\namendment_geotechnical_structures.\ntac_amendments.\n\nTabelas utilizadas:\n\nentrepreneurs: Empreendedores de estruturas geotécnicas.\n\nTabela criada pela equipe da AECOM, não fazemos alterações nos scripts gerados pela R6. Aparentemente é criado no repositório ciga-mpmg/ciga2.0.\nUtilizada em: Painel Descaracterização.\n\ngeotechnical_structures: Estruturas geotécnicas.\n\nTabela criada pela equipe da AECOM, não fazemos alterações nos scripts gerados pela R6. Aparentemente é criado no repositório ciga-mpmg/ciga2.0.\nUtilizada em: Painel Descaracterização.\n\ntac_decharacterisations: Tacs de descaracterização de estruturas geotécnicas.\n\nTabela criada pela equipe da AECOM, não fazemos alterações nos scripts gerados pela R6.\nUtilizada em: Painel Descaracterização.\n\ntacs: Tacs de estruturas geotécnicas (não são de descaracterização).\n\nTabela criada pela equipe da AECOM, não fazemos alterações nos scripts gerados pela R6. Aparentemente é criado no repositório ciga-mpmg/ciga2.0.\nUtilizada em: Painel Recomendações.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Bancos de dados</span>"
    ]
  },
  {
    "objectID": "bancos-de-dados.html#banco-de-dados-aecom_ciga_homolog",
    "href": "bancos-de-dados.html#banco-de-dados-aecom_ciga_homolog",
    "title": "2  Bancos de dados",
    "section": "",
    "text": "Importante\n\n\n\nEsse banco de dados tem “AECOM” no nome. O Rubem disse que isso não é desejável. Checar com a equipe da AECOM o que fazer sobre isso.\n\n\n\n\n\n\n\n\n\ncomarcasTJMG: Comarcas do TJMG.\n\nETL feito pelo workflow download-comarcas-TJMG, no repositório ciga-mpmg/download_comarcas_TJMG. Depende do pacote comarcasTJMG.\nUtilizada em: Resuvafeca.\n\n\n\n\n\n\n\n\nImportante\n\n\n\nNo README do repositório comarcasTJMG, está como se o repositório estivesse no GitHub do Rubem.\n\n\n\nrecommendations3: …\nsigbm: …\nsigbm_atual: …\ndados_recomendacoes_sigbm: Join feito com as tabelas recommendations3 e sigbm.\n\nETL feito pelo workflow update-sigbm, no repositório ciga-mpmg/aecom_sigbm\nUtilizada em: Painel Recomendações, Relatório Gerencial.\n\n\n\n\n\n\n\n\nImportante\n\n\n\nO repositório do workflow (ciga-mpmg/aecom_sigbm) tem “aecom” no nome. Precisa ser renomeado.\n\n\n\ndados_recomendacoes_sigbm_complexo_minerario: Tratamentos feito com as tabelas dados_recomendacoes_sigbm e sigbm.\n\nETL feito pelo workflow update-sigbm, no repositório ciga-mpmg/aecom_sigbm\nUtilizada em: Painel Recomendações.\n\n\n\n\n\n\n\n\nImportante\n\n\n\nMe parece que antes esse fluxo era necessário pois as tabelas de complexo minerário estavam separadas. Agora, como vem com o banco, talvez seria bom reavaliar com calma.\n\n\n\ndados_sigbm_atualizacao_mensal: Tratamento da tabela sigbm para gerar a tabela de atualização mensal.\n\nETL feito pelo workflow update-sigbm, no repositório ciga-mpmg/aecom_sigbm\nUtilizada em: Painel Barragens.\n\ndados_sigbm_linha_do_tempo: Tratamento da tabela sigbm para gerar linha do tempo.\n\nETL feito pelo workflow update-sigbm, no repositório ciga-mpmg/aecom_sigbm\nUtilizada em: Painel Barragens.\n\nfull_recommendations: …\nide_sisema: …\nmetadados_documentos_tacs: …\nmetadados_imagens_satelite_bucket: …\nmetadados_mascaras_imagens_satelite_bucket: …\nmetadados_relatorios_gerenciais: …\nsigbm_dados_cadastrais: …\nsigbm_dados_cadastrais_atual: …\n\n\n\n\n\n\n\nTabelas que deverão ser deletadas após parar de usar o Shinyapps:\n\nentrepreneurs cópia antiga da tabela presente no banco de dados cadastro-tacs.\ngeotechnical_structures cópia antiga da tabela presente no banco de dados cadastro-tacs.\ntac_decharacterisations cópia antiga da tabela presente no banco de dados cadastro-tacs.\ntacs cópia antiga da tabela presente no banco de dados cadastro-tacs.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Bancos de dados</span>"
    ]
  },
  {
    "objectID": "bancos-de-dados.html#banco-de-dados-externo",
    "href": "bancos-de-dados.html#banco-de-dados-externo",
    "title": "2  Bancos de dados",
    "section": "2.2 Banco de dados externo",
    "text": "2.2 Banco de dados externo\nO banco de dados cadastro-tacs contém informações sobre os TACs (Termos de Ajustamento de Conduta) firmados pelo Ministério Público com empresas privadas.\nEsse banco de dados é utilizado nos seguintes repositórios:\n\nPainel Recomendações (ciga-mpmg/painelRecomendacoes)\nPainel Descaracterização (ciga-mpmg/painelDescaracterizacao)\n\n\n\n\n\n\n\nImportante\n\n\n\nO painelInfoTacs deveria usar os dados deste banco, certo? Conferir se está usando mesmo. Não apareceu na pesquisa do GitHub.\n\n\nTabelas utilizadas:\n\nentrepreneurs: Empreendedores de estruturas geotécnicas.\n\nUtilizada em: Painel Descaracterização.\n\ngeotechnical_structures: Estruturas geotécnicas.\n\nUtilizada em: Painel Descaracterização.\n\ntac_decharacterisations: Tacs de descaracterização de estruturas geotécnicas.\n\nUtilizada em: Painel Descaracterização.\n\ntacs: Tacs de estruturas geotécnicas (não são de descaracterização).\n\nUtilizada em: Painel Recomendações.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Bancos de dados</span>"
    ]
  },
  {
    "objectID": "bancos-de-dados.html#banco-de-dados-principal",
    "href": "bancos-de-dados.html#banco-de-dados-principal",
    "title": "2  Bancos de dados",
    "section": "",
    "text": "Importante\n\n\n\nEsse banco de dados tem “AECOM” no nome. O Rubem disse que isso não é desejável. Checar com a equipe da AECOM o que fazer sobre isso.\n\n\n\n\n\n\n\n\n\ncomarcasTJMG: Comarcas do TJMG.\n\nETL feito pelo workflow download-comarcas-TJMG, no repositório ciga-mpmg/download_comarcas_TJMG. Depende do pacote comarcasTJMG.\nUtilizada em: Resuvafeca.\n\n\n\n\n\n\n\n\nImportante\n\n\n\nNo README do repositório comarcasTJMG, está como se o repositório estivesse no GitHub do Rubem.\n\n\n\nrecommendations3: …\nsigbm: …\nsigbm_atual: …\ndados_recomendacoes_sigbm: Join feito com as tabelas recommendations3 e sigbm.\n\nETL feito pelo workflow update-sigbm, no repositório ciga-mpmg/aecom_sigbm\nUtilizada em: Painel Recomendações, Relatório Gerencial.\n\n\n\n\n\n\n\n\nImportante\n\n\n\nO repositório do workflow (ciga-mpmg/aecom_sigbm) tem “aecom” no nome. Precisa ser renomeado.\n\n\n\ndados_recomendacoes_sigbm_complexo_minerario: Tratamentos feito com as tabelas dados_recomendacoes_sigbm e sigbm.\n\nETL feito pelo workflow update-sigbm, no repositório ciga-mpmg/aecom_sigbm\nUtilizada em: Painel Recomendações.\n\n\n\n\n\n\n\n\nImportante\n\n\n\nMe parece que antes esse fluxo era necessário pois as tabelas de complexo minerário estavam separadas. Agora, como vem com o banco, talvez seria bom reavaliar com calma.\n\n\n\ndados_sigbm_atualizacao_mensal: Tratamento da tabela sigbm para gerar a tabela de atualização mensal.\n\nETL feito pelo workflow update-sigbm, no repositório ciga-mpmg/aecom_sigbm\nUtilizada em: Painel Barragens.\n\ndados_sigbm_linha_do_tempo: Tratamento da tabela sigbm para gerar linha do tempo.\n\nETL feito pelo workflow update-sigbm, no repositório ciga-mpmg/aecom_sigbm\nUtilizada em: Painel Barragens.\n\nfull_recommendations: …\nide_sisema: …\nmetadados_documentos_tacs: …\nmetadados_imagens_satelite_bucket: …\nmetadados_mascaras_imagens_satelite_bucket: …\nmetadados_relatorios_gerenciais: …\nsigbm_dados_cadastrais: …\nsigbm_dados_cadastrais_atual: …\n\n\n\n\n\n\n\nTabelas que deverão ser deletadas após parar de usar o Shinyapps:\n\nentrepreneurs cópia antiga da tabela presente no banco de dados cadastro-tacs.\ngeotechnical_structures cópia antiga da tabela presente no banco de dados cadastro-tacs.\ntac_decharacterisations cópia antiga da tabela presente no banco de dados cadastro-tacs.\ntacs cópia antiga da tabela presente no banco de dados cadastro-tacs.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Bancos de dados</span>"
    ]
  },
  {
    "objectID": "paineis.html",
    "href": "paineis.html",
    "title": "1  Painéis do CIGA-MPMG",
    "section": "",
    "text": "1.1 Estrutura básica\nTodos os paineis com exeção de painelMain dependem de uma série de configurações e dependências de ambiente. São elas:\nTodos os apps contam com uma infraestrutura de login que depende das variáveis de ambiente. Essa infraestrutura é:\nAs configurações para obter o endpoint de validação do login estão registradas em https://github.com/ciga-mpmg/painelAssets/blob/main/inst/app/golem-config.yml. A mecânica e front-end de validação estão no repositório painelLogin.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Painéis do CIGA-MPMG</span>"
    ]
  },
  {
    "objectID": "paineis.html#estrutura-básica",
    "href": "paineis.html#estrutura-básica",
    "title": "1  Painéis do CIGA-MPMG",
    "section": "",
    "text": "Ubuntu 20.04\nR 4.2.1 ou superior\nShiny-Server em versão 1.5.19 ou superior\nVariáveis de ambiente:\n\nCIGA_SQL_HOST  # endereço de acesso ao banco de dados\nCIGA_SQL_DATABASE # banco de dados\nCIGA_SQL_USER # usuário do banco\nCIGA_SQL_PORT # porta do banco\nCIGA_SQL_PASSWORD # senha\nAMBIENTE # stringr que deve ser \"homolog\" ou \"prod\"\nCIGA_OUTLOOK_TENANT # tenant do outlook\nCIGA_OUTLOOK_APP # id do aplicativo do outlook\nCIGA_OUTLOOK_PASSWORD # senha do outlook\nCIGA_FIREBASE_PASSWORD # senha de acesso ao firebase no usuario contato@ciga-mpmg.com.br\nCIGA_FIREBASE_PROJECT_API=\"AIzaSyCH-0lM6fq2Wgx7NfGedRDJnV9Bxa4ifoo\" # projeto do firebase\n\nif (ambiente %in% c(\"homolog\", \"prod\")) {\n    url &lt;- get_golem_config(\"url\", Sys.getenv(\"AMBIENTE\"))\n    validation_endpoint &lt;- get_golem_config(\n      \"validation_endpoint\",\n      Sys.getenv(\"AMBIENTE\")\n    )\n    active_ui &lt;- painelLogin:::create_app_ui_auth(\n      request,\n      app_ui,\n      url,\n      validation_endpoint\n    )\n  } else {\n    active_ui &lt;- app_ui\n    url &lt;- NULL\n  }",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Painéis do CIGA-MPMG</span>"
    ]
  },
  {
    "objectID": "paineis.html#mecanismo-de-autenticação",
    "href": "paineis.html#mecanismo-de-autenticação",
    "title": "1  Painéis do CIGA-MPMG",
    "section": "1.2 Mecanismo de autenticação",
    "text": "1.2 Mecanismo de autenticação\nO mecanismo de autenticação de todo acesso se divide em dois casos: se há token de acesso nos cookies do usuário ou não. Se não houver, o fluxo de acesso é:\n\nInterromper o acesso ao app e expor a UI de login do painelLogin.\nA função validate_session usa o ToolKit do firebase para verificar se as credenciais são válidas.\nSe forem válidas, um token é devolvido paro usuário e salvo nos cookies.\nQuando as credenciais são válidas também é fornecido acesso ao painel.\n\n\nknitr::include_graphics(\"img/fluxoFirebase.png\")",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Painéis do CIGA-MPMG</span>"
    ]
  },
  {
    "objectID": "paineis.html#direcionamento-via-nginx",
    "href": "paineis.html#direcionamento-via-nginx",
    "title": "1  Painéis do CIGA-MPMG",
    "section": "1.3 Direcionamento via nginx",
    "text": "1.3 Direcionamento via nginx\nA compatibilização de todos os apps como uma única aplicação é feita com direcionamento via nginx. As configurações de location do nginx são:\n    location / {\n                # block added from rstudio support doc\n                proxy_pass http://localhost:3838;\n                proxy_redirect / $scheme://$http_host/;\n                proxy_http_version 1.1;\n                proxy_set_header Upgrade $http_upgrade;\n                proxy_set_header Connection $connection_upgrade;\n                proxy_read_timeout 20d;\n                proxy_buffering off;\n    }\nJá as configurações de redirecionamento são\nserver {\n\n        listen 80;\n        server_name painel-homolog.ciga-mpmg.com.br;\n        rewrite     ^   https://$server_name$request_uri? redirect;\n\n        # Tamamho maximo de upload\n        #client_max_body_size 125m;\n\n        #proxy_headers_hash_max_size 2048;\n        #proxy_headers_hash_bucket_size 128;\n\n\n    location ^~ /.well-known/acme-challenge/ {\n         alias /var/www/html/.well-known/acme-challenge/;\n    }\n\n    location / {\n      proxy_pass http://127.0.0.1:3838/painelMain$request_uri;\n      proxy_redirect / $scheme://$http_host$request_uri;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection $connection_upgrade;\n      proxy_read_timeout 20d;\n      proxy_buffering off;\n\n\n       # Websockets support\n  #      proxy_set_header Upgrade \"websocket\";\n  #      proxy_set_header Connection \"Upgrade\";\n\n    }\n\n    location /recomendacoes {\n      proxy_pass http://127.0.0.1:3838/painelRecomendacoes/;\n      proxy_redirect / $scheme://$http_host$request_uri;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection $connection_upgrade;\n      proxy_read_timeout 20d;\n      proxy_buffering off;\n\n    }\n}\n\nserver {\n    listen 443 ssl;\n    server_name painel-homolog.ciga-mpmg.com.br;\n\n    ssl on;\n    ssl_certificate       /etc/letsencrypt/live/painel-homolog.ciga-mpmg.com.br/fullchain.pem;\n    ssl_certificate_key   /etc/letsencrypt/live/painel-homolog.ciga-mpmg.com.br/privkey.pem;\n\n    proxy_headers_hash_max_size 2048;\n    proxy_headers_hash_bucket_size 128;\n\n    location ^~ /.well-known/acme-challenge/ {\n         alias /var/www/html/.well-known/acme-challenge/;\n    }\n\n    location / {\n      proxy_pass http://127.0.0.1:3838/painelMain$request_uri;\n      proxy_redirect / $scheme://$http_host$request_uri;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection $connection_upgrade;\n      proxy_read_timeout 20d;\n      proxy_buffering off;\n\n    error_page 404 500 502 /usr/share/nginx/html/custom_404.html;\n\n    }\n\n    location /recomendacoes/ {\n      proxy_pass http://127.0.0.1:3838/painelRecomendacoes/;\n      proxy_redirect / $scheme://$http_host$request_uri;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection $connection_upgrade;\n      proxy_read_timeout 20d;\n      proxy_buffering off;\n\n    }\n\n    location /tacs/ {\n      proxy_pass http://127.0.0.1:3838/painelInfoTacs/;\n      proxy_redirect / $scheme://$http_host$request_uri;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection $connection_upgrade;\n      proxy_read_timeout 20d;\n      proxy_buffering off;\n\n\n    }\n\n        location /barragens/ {\n      proxy_pass http://127.0.0.1:3838/painelBarragens/;\n      proxy_redirect / $scheme://$http_host$request_uri;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection $connection_upgrade;\n      proxy_read_timeout 20d;\n      proxy_buffering off;\n\n\n    }\n\n        location /descaracterizacao/ {\n      proxy_pass http://127.0.0.1:3838/painelDescaracterizacao/;\n      proxy_redirect / $scheme://$http_host$request_uri;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection $connection_upgrade;\n      proxy_read_timeout 20d;\n      proxy_buffering off;\n\n      error_page 404 500 502 /usr/share/nginx/html/custom_404.html;\n\n    }\n}",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Painéis do CIGA-MPMG</span>"
    ]
  },
  {
    "objectID": "workflows.html",
    "href": "workflows.html",
    "title": "3  Workflows com GitHub Actions",
    "section": "",
    "text": "Para executar a obtenção e a preparação dos utilizados nos painéis e outros produtos relacionados ao CIGA, existem diversos workflows que são executados pelo GitHub Actions.\nWorkflows são arquivos de configuração que definem um conjunto de ações que são executadas em um ambiente de execução. Em alguns casos, o ambiente de execução são máquinas virtuais pertencentes à GitHub, em outros, o servidor do próprio CIGA.\nOs workflows existentes, e as informações sobre eles, estão descritas no arquivo https://github.com/ciga-mpmg/painelActions/blob/main/README.md.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Workflows com GitHub Actions</span>"
    ]
  }
]