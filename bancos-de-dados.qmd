---
knitr:
  opts_chunk:
    echo: false
---

# Bancos de dados

Nesta seção, o objetivo é apresentar quais são os bancos de dados utilizados no projeto, bem como as tabelas utilizadas, e em quais partes do projeto é utilizado.

## Banco de dados principal

O banco de dados `aecom_ciga_homolog` contém diversas bases de dados de temas como: recomendações, sigbm, tabelas que deverão ser deletadas após parar de usar o Shinyapps, entre outros.

::: callout-important
Esse banco de dados tem "AECOM" no nome. O Rubem disse que isso não é desejável. Checar com a equipe da AECOM o que fazer sobre isso.
:::

### Painéis que utilizam o banco de dados

Esse banco de dados é utilizado nos seguintes painéis:

-   [`painelRecomendacoes`](https://github.com/ciga-mpmg/painelRecomendacoes)
-   [`painelBarragens`](https://github.com/ciga-mpmg/Barragens)

### Tabelas no banco de dados

Segue abaixo a lista de tabelas presentes no banco de dados `aecom_ciga_homolog`:

```{r}
con_recomendacoes <- DBI::dbConnect(
  drv = RPostgres::Postgres(),
  host = Sys.getenv("CIGA_SQL_HOST"),
  dbname = 'aecom_ciga_homolog',
  user = Sys.getenv("CIGA_SQL_USER"),
  port = Sys.getenv("CIGA_SQL_PORT"),
  password = Sys.getenv("CIGA_SQL_PASSWORD"),
)

tabelas_no_bd_reco <- RSQLite::dbListTables(con_recomendacoes)

tabelas_no_bd_reco |>
  sort() |>
  writeLines()
```

### Descrição das tabelas

```{r}
# dplyr::tbl(con_recomendacoes, "dados_recomendacoes_sigbm") |>
#   dplyr::collect()
```

**Tabelas não utilizadas** (são criadas pelo próprio sistema de banco de dados, e não são manipuladas/utilizadas no projeto):

`geography_columns`, `geometry_columns`, `pg_stat_statements`, `pg_stat_statements_info`, `spatial_ref_sys`.

**Tabelas utilizadas**:

-   `comarcasTJMG`:
    -   **Descrição:** Comarcas do TJMG.
    -   **Criação:** ETL feito pelo workflow [`download-comarcas-TJMG`](https://github.com/ciga-mpmg/download_comarcas_TJMG/actions/workflows/update-data.yaml), no repositório [`ciga-mpmg/download_comarcas_TJMG`](https://github.com/ciga-mpmg/download_comarcas_TJMG). Depende do pacote [`comarcasTJMG`](https://github.com/ciga-mpmg/comarcasTJMG).
    -   **Leitura:** [scraper_sigbm](https://github.com/ciga-mpmg/scraper_sigbm).
-   `recommendations3`:
    -   **Descrição:** Tabela de recomendações emitidas para os TACs, por auditorias.
    -   **Criação:** Sistema de cadastro de TACs.
    -   **Leitura:** [scraper_sigbm](https://github.com/ciga-mpmg/scraper_sigbm), [relatorioGerencial](https://github.com/ciga-mpmg/relatorioGerencial).
-   `sigbm`:
    -   **Descrição:** Tabela completa de informações extraídas da página principal do SIGBM, com informações sobre barragens no estado de Minas Gerais.
    -   **Criação:** ETL realizado no repositório [scraper_sigbm](https://github.com/ciga-mpmg/scraper_sigbm).
    -   **Leitura:** [scraper_sigbm](https://github.com/ciga-mpmg/scraper_sigbm), [painelBarragens](https://github.com/ciga-mpmg/painelBarragens).
-   `sigbm_atual`:
    -   **Descrição:** Tabela apenas com as informações mais recentes extraídas da página principal do SIGBM, com informações sobre barragens no estado de Minas Gerais.
    -   **Criação:** ETL realizado no repositório [scraper_sigbm](https://github.com/ciga-mpmg/scraper_sigbm).
    -   **Leitura:** [scraper_sigbm](https://github.com/ciga-mpmg/scraper_sigbm), [painelBarragens](https://github.com/ciga-mpmg/painelBarragens).
-   `sigbm_atual_com_comarcas`:
    -   **Descrição:** Tabela apenas com as informações mais recentes extraídas da página principal do SIGBM, com informações sobre barragens no estado de Minas Gerais, e suas respectivas comarcas.
    -   **Criação:** ETL realizado no repositório [scraper_sigbm](https://github.com/ciga-mpmg/scraper_sigbm).
    -   **Leitura:** [painelBarragens](https://github.com/ciga-mpmg/painelBarragens).
-   `dados_recomendacoes_sigbm`:
    -   **Descrição:** União (join) feita a partir das tabelas `recommendations3` e `sigbm`.
    -   **Criação:** repositório [scraper_sigbm](https://github.com/ciga-mpmg/scraper_sigbm).
    -   **Leitura:** [scraper_sigbm](https://github.com/ciga-mpmg/scraper_sigbm), [painelRecomendacoes](https://github.com/ciga-mpmg/painelRecomendacoes), [relatorioGerencial](https://github.com/ciga-mpmg/relatorioGerencial).
-   `dados_recomendacoes_sigbm_complexo_minerario`:
    -   **Descrição:** Resultado da união (join) da tabela com as recomendações, informações sobre o sigbm e informações sobre o complexo minerário.
    -   **Criação:** repositório [scraper_sigbm](https://github.com/ciga-mpmg/scraper_sigbm).
    -   **Leitura:** [painelRecomendacoes](https://github.com/ciga-mpmg/painelRecomendacoes), [googleStorageMetadata](https://github.com/ciga-mpmg/googleStorageMetadata).

::: callout-important
\[JAN/2024\] Me parece que antes esse fluxo era necessário pois as tabelas de complexo minerário estavam separadas. Agora, como vem com o banco, talvez seria bom reavaliar com calma se isso está fazendo sentido.
:::

-   `dados_sigbm_atualizacao_mensal`:
    -   **Descrição:** Tratamento da tabela `sigbm` para gerar a tabela de atualização mensal.
    -   **Criação:** repositório [scraper_sigbm](https://github.com/ciga-mpmg/scraper_sigbm).
    -   **Leitura:** [painelBarragens](https://github.com/ciga-mpmg/painelBarragens).
-   `dados_sigbm_linha_do_tempo` e `dados_sigbm_linha_do_tempo_parcial`:
    -   **Descrição:** Tratamento da tabela `sigbm` para gerar linha do tempo.
    -   **Criação:** repositório [scraper_sigbm](https://github.com/ciga-mpmg/scraper_sigbm).
    -   **Leitura:** [painelBarragens](https://github.com/ciga-mpmg/painelBarragens).
-   `full_recommendations`:
    -   **Descrição:** ??
    -   **Criação:** ??
    -   **Leitura:** Nenhum
-   `ide_sisema`:
    -   **Descrição:** Dados do IDE SISEMA.
    -   **Criação:** [download_IDE_SISEMA](https://github.com/ciga-mpmg/download_IDE_SISEMA)
    -   **Leitura:** Nenhum
-   `metadados_documentos_tacs`, `metadados_imagens_satelite_bucket`, `metadados_imagens_satelite_bucket_local`, `metadados_mascaras_imagens_satelite_bucket`, `metadados_relatorios_gerenciais`:
    -   **Descrição:** Metadados extraídos do Google Storage, com informações sobre os documentos dos TACs, imagens de satélite, relatórios gerenciais, etc.
    -   **Criação:** [googleStorageMetadata](https://github.com/ciga-mpmg/googleStorageMetadata).
    -   **Leitura:** [painelBarragens](https://github.com/ciga-mpmg/painelBarragens), [painelRecomendacoes](https://github.com/ciga-mpmg/painelRecomendacoes).
-   `sigbm_dados_cadastrais` e `sigbm_dados_cadastrais_atual`:
    -   **Descrição:** Dados extraídos da página completa do SIGBM, com informações sobre barragens no estado de Minas Gerais. Essa base de dados contém mais dados do que a base `sigbm`.
    -   **Criação:** [ciga-monitoramento-info-barragens/sigbm-dados-cadastrais](https://github.com/ciga-monitoramento-info-barragens/sigbm-dados-cadastrais)
    -   **Leitura:** Nenhum.

::: callout
**Tabelas que ainda são usadas no painel do Shinyapps, mas que agora usamos do banco de dados`cadastro-tacs` e poderão ser deletadas futuramente do banco de dados `aecom_ciga_homolog`**:

-   `entrepreneurs` cópia antiga da tabela presente no banco de dados `cadastro-tacs`.

-   `geotechnical_structures` cópia antiga da tabela presente no banco de dados `cadastro-tacs`.

-   `tac_decharacterisations` cópia antiga da tabela presente no banco de dados `cadastro-tacs`.

-   `tacs` cópia antiga da tabela presente no banco de dados `cadastro-tacs`.

**ATENÇÃO**: Analisar se essas tabelas estão sendo utilizadas em algum lugar antes de deletá-las.
:::

## Banco de dados externo

O banco de dados `cadastro-tacs` contém informações sobre os TACs (Termos de Ajustamento de Conduta) firmados pelo Ministério Público com empresas privadas.

Esse banco de dados é utilizado nos seguintes repositórios:

-   Painel Recomendações [(`ciga-mpmg/painelRecomendacoes`)](https://github.com/ciga-mpmg/painelRecomendacoes)

::: callout-important
\[JAN/2024\] O painelInfoTacs deveria usar os dados deste banco, certo? Conferir se está usando mesmo. Não apareceu na pesquisa do GitHub.

\[MAIO/2024\] Conferi, e no código ele está conectando com a base de recomendações. Não está conectando com a base de cadastro de TACs. Isso precisará ser alterado.
:::

```{r}
# con_cadastro_tacs <- DBI::dbConnect(
#   drv = RPostgres::Postgres(),
#   host = Sys.getenv("CIGA_SQL_HOST"),
#   dbname = 'cadastro_tacs',
#   user = Sys.getenv("CIGA_SQL_USER"),
#   port = Sys.getenv("CIGA_SQL_PORT"),
#   password = Sys.getenv("CIGA_SQL_PASSWORD"),
# )
#
# tabelas_cadastro_tacs <- RSQLite::dbListTables(con_cadastro_tacs)

# tabelas_cadastro_tacs |>
#   sort() |>
#   writeLines()


# dplyr::tbl(con_cadastro_tacs, "tac_amendments") |>
#   dplyr::collect()
```

**Tabelas utilizadas**:

<!-- -   `entrepreneurs`: Empreendedores de estruturas geotécnicas. -->

<!--     -   Utilizada em: Painel Descaracterização. -->

<!-- -   `geotechnical_structures`: Estruturas geotécnicas. -->

<!--     -   Utilizada em: Painel Descaracterização. -->

<!-- -   `tac_decharacterisations`: Tacs de descaracterização de estruturas geotécnicas. -->

<!--     -   Utilizada em: Painel Descaracterização. -->

-   `tacs`: Tacs de estruturas geotécnicas (não são de descaracterização).
    -   Utilizada em: Painel Recomendações.
